# 代码仓扫描任务接口文档

## 基础信息

- **服务器地址**: `http://localhost:8080`
- **基础路径**: `/api/tasks`
- **数据格式**: JSON
- **字符编码**: UTF-8

---

## 接口列表

### 1. 创建代码仓扫描任务

**接口地址**: `POST /api/tasks`

**请求方式**: POST

**请求头**:
```
Content-Type: application/json
```

**请求体**:
```json
{
  "taskName": "Spring Boot项目代码扫描",
  "repoUrl": "https://github.com/example/spring-boot-demo.git",
  "branch": "main",
  "pathList": "src/main/java,src/test/java",
  "s3Path": "s3://scan-results/task-001/",
  "creator": "zhangsan",
  "taskStatus": "CREATED",
  "assistantVersion": "v1.2.0"
}
```

**请求参数说明**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| taskName | String | 是 | 任务名称 |
| repoUrl | String | 是 | 代码仓URL地址 |
| branch | String | 是 | 扫描分支 |
| pathList | String | 否 | 扫描路径列表，多个路径用逗号分隔 |
| s3Path | String | 否 | 扫描结果保存的S3桶路径 |
| creator | String | 是 | 任务创建人 |
| taskStatus | String | 否 | 任务状态（CREATED/SCANNING/COMPLETED/FAILED），默认为CREATED |
| assistantVersion | String | 否 | 扫描助手版本 |

**注意**: `taskId` 和 `createTime` 会自动生成，无需在请求体中提供。

**响应示例** (成功):
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "taskId": "550e8400-e29b-41d4-a716-446655440000",
    "taskName": "Spring Boot项目代码扫描",
    "repoUrl": "https://github.com/example/spring-boot-demo.git",
    "branch": "main",
    "pathList": "src/main/java,src/test/java",
    "s3Path": "s3://scan-results/task-001/",
    "creator": "zhangsan",
    "createTime": "2024-01-20T10:30:00",
    "taskStatus": "CREATED",
    "assistantVersion": "v1.2.0"
  }
}
```

**响应示例** (失败):
```json
{
  "code": 500,
  "message": "创建失败: 具体错误信息",
  "data": null
}
```

**调用方式** (PowerShell):
```powershell
$body = @{
    taskName = "Spring Boot项目代码扫描"
    repoUrl = "https://github.com/example/spring-boot-demo.git"
    branch = "main"
    pathList = "src/main/java,src/test/java"
    s3Path = "s3://scan-results/task-001/"
    creator = "zhangsan"
    taskStatus = "CREATED"
    assistantVersion = "v1.2.0"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/tasks" -Method Post -Body $body -ContentType "application/json"
```

**调用方式** (curl):
```bash
curl -X POST http://localhost:8080/api/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "taskName": "Spring Boot项目代码扫描",
    "repoUrl": "https://github.com/example/spring-boot-demo.git",
    "branch": "main",
    "pathList": "src/main/java,src/test/java",
    "s3Path": "s3://scan-results/task-001/",
    "creator": "zhangsan",
    "taskStatus": "CREATED",
    "assistantVersion": "v1.2.0"
  }'
```

---

### 2. 查询所有任务

**接口地址**: `GET /api/tasks`

**请求方式**: GET

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "taskId": "task-001",
      "taskName": "Spring Boot项目代码扫描",
      "repoUrl": "https://github.com/example/spring-boot-demo.git",
      "branch": "main",
      "pathList": "src/main/java,src/test/java",
      "s3Path": "s3://scan-results/task-001/",
      "creator": "zhangsan",
      "createTime": "2024-01-15T10:00:00",
      "taskStatus": "COMPLETED",
      "assistantVersion": "v1.2.0"
    },
    {
      "taskId": "task-002",
      "taskName": "微服务架构代码审查",
      "repoUrl": "https://github.com/example/microservice-app.git",
      "branch": "develop",
      "pathList": "src/main/java/com/example/service",
      "s3Path": "s3://scan-results/task-002/",
      "creator": "lisi",
      "createTime": "2024-01-16T14:30:00",
      "taskStatus": "SCANNING",
      "assistantVersion": "v1.3.0"
    }
  ]
}
```

**调用方式**:
- 浏览器: `http://localhost:8080/api/tasks`
- curl: `curl http://localhost:8080/api/tasks`
- PowerShell: `Invoke-RestMethod -Uri "http://localhost:8080/api/tasks" -Method Get`

---

### 3. 根据创建人查询任务列表

**接口地址**: `GET /api/tasks?creator=xxx`

**请求方式**: GET

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| creator | String | 是 | 任务创建人 |

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "taskId": "task-001",
      "taskName": "Spring Boot项目代码扫描",
      "repoUrl": "https://github.com/example/spring-boot-demo.git",
      "branch": "main",
      "pathList": "src/main/java,src/test/java",
      "s3Path": "s3://scan-results/task-001/",
      "creator": "zhangsan",
      "createTime": "2024-01-15T10:00:00",
      "taskStatus": "COMPLETED",
      "assistantVersion": "v1.2.0"
    },
    {
      "taskId": "task-004",
      "taskName": "API接口代码扫描",
      "repoUrl": "https://github.com/example/api-service.git",
      "branch": "main",
      "pathList": "src/main/java/com/api",
      "s3Path": "s3://scan-results/task-004/",
      "creator": "zhangsan",
      "createTime": "2024-01-18T16:45:00",
      "taskStatus": "COMPLETED",
      "assistantVersion": "v1.2.0"
    }
  ]
}
```

**调用方式**:
- 浏览器: `http://localhost:8080/api/tasks?creator=zhangsan`
- curl: `curl "http://localhost:8080/api/tasks?creator=zhangsan"`
- PowerShell: `Invoke-RestMethod -Uri "http://localhost:8080/api/tasks?creator=zhangsan" -Method Get`

---

### 4. 根据任务ID查询任务详情

**接口地址**: `GET /api/tasks/{taskId}`

**请求方式**: GET

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| taskId | String | 是 | 任务ID |

**响应示例** (成功):
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "taskId": "task-001",
    "taskName": "Spring Boot项目代码扫描",
    "repoUrl": "https://github.com/example/spring-boot-demo.git",
    "branch": "main",
    "pathList": "src/main/java,src/test/java",
    "s3Path": "s3://scan-results/task-001/",
    "creator": "zhangsan",
    "createTime": "2024-01-15T10:00:00",
    "taskStatus": "COMPLETED",
    "assistantVersion": "v1.2.0"
  }
}
```

**响应示例** (失败):
```json
{
  "code": 404,
  "message": "任务不存在",
  "data": null
}
```

**调用方式**:
- 浏览器: `http://localhost:8080/api/tasks/task-001`
- curl: `curl http://localhost:8080/api/tasks/task-001`
- PowerShell: `Invoke-RestMethod -Uri "http://localhost:8080/api/tasks/task-001" -Method Get`

---

### 5. 更新任务状态

**接口地址**: `PUT /api/tasks/{taskId}/status`

**请求方式**: PUT

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| taskId | String | 是 | 任务ID |

**请求头**:
```
Content-Type: application/json
```

**请求体**:
```json
{
  "taskStatus": "SCANNING"
}
```

**请求参数说明**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| taskStatus | String | 是 | 任务状态（CREATED/SCANNING/COMPLETED/FAILED） |

**响应示例** (成功):
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

**响应示例** (失败 - 参数错误):
```json
{
  "code": 400,
  "message": "任务状态不能为空",
  "data": null
}
```

**响应示例** (失败 - 任务不存在):
```json
{
  "code": 404,
  "message": "任务不存在或更新失败",
  "data": null
}
```

**调用方式** (PowerShell):
```powershell
$body = @{
    taskStatus = "SCANNING"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/tasks/task-001/status" -Method Put -Body $body -ContentType "application/json"
```

**调用方式** (curl):
```bash
curl -X PUT http://localhost:8080/api/tasks/task-001/status \
  -H "Content-Type: application/json" \
  -d '{"taskStatus": "SCANNING"}'
```

---

## 任务状态说明

| 状态值 | 说明 |
|--------|------|
| CREATED | 已创建，等待扫描 |
| SCANNING | 扫描中 |
| COMPLETED | 扫描完成 |
| FAILED | 扫描失败 |

---

## 统一响应格式

所有接口返回统一的JSON格式：

```json
{
  "code": 200,           // 状态码：200成功，400参数错误，404未找到，500服务器错误
  "message": "操作结果描述",
  "data": {}             // 数据内容，可能为对象、数组或null
}
```

**状态码说明**:
- `200`: 操作成功
- `400`: 请求参数错误
- `404`: 资源不存在
- `500`: 服务器内部错误

---

## 测试数据

项目启动时会自动插入以下测试任务：

| 任务ID | 任务名称 | 创建人 | 状态 | 扫描助手版本 |
|--------|---------|--------|------|-------------|
| task-001 | Spring Boot项目代码扫描 | zhangsan | COMPLETED | v1.2.0 |
| task-002 | 微服务架构代码审查 | lisi | SCANNING | v1.3.0 |
| task-003 | 前端代码质量检查 | wangwu | CREATED | v1.1.0 |
| task-004 | API接口代码扫描 | zhangsan | COMPLETED | v1.2.0 |
| task-005 | 数据库访问层扫描 | zhaoliu | FAILED | v1.0.0 |

---

## 快速测试脚本 (PowerShell)

```powershell
# 1. 查询所有任务
Invoke-RestMethod -Uri "http://localhost:8080/api/tasks" -Method Get

# 2. 查询zhangsan创建的任务
Invoke-RestMethod -Uri "http://localhost:8080/api/tasks?creator=zhangsan" -Method Get

# 3. 查询任务详情
Invoke-RestMethod -Uri "http://localhost:8080/api/tasks/task-001" -Method Get

# 4. 创建新任务
$newTask = @{
    taskName = "新项目代码扫描"
    repoUrl = "https://github.com/example/new-project.git"
    branch = "main"
    pathList = "src/main/java"
    creator = "test_user"
    taskStatus = "CREATED"
    assistantVersion = "v1.2.0"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/tasks" -Method Post -Body $newTask -ContentType "application/json"

# 5. 更新任务状态
$statusUpdate = @{
    taskStatus = "SCANNING"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/tasks/task-001/status" -Method Put -Body $statusUpdate -ContentType "application/json"
```

---

## 注意事项

1. **数据持久化**: 项目使用H2内存数据库，应用重启后数据会丢失
2. **字符编码**: 所有接口支持UTF-8编码，可以正常处理中文
3. **任务ID**: 创建任务时，如果不提供taskId，系统会自动生成UUID
4. **创建时间**: 创建任务时，如果不提供createTime，系统会自动设置为当前时间
5. **任务状态**: 创建任务时，如果不提供taskStatus，默认为"CREATED"
6. **错误处理**: 所有接口都有统一的错误响应格式

---

## 完整测试示例

### 场景1：创建并查询任务

```powershell
# 1. 创建任务
$task = @{
    taskName = "测试任务"
    repoUrl = "https://github.com/example/test.git"
    branch = "main"
    pathList = "src/main/java"
    creator = "test_user"
    assistantVersion = "v1.2.0"
} | ConvertTo-Json

$result = Invoke-RestMethod -Uri "http://localhost:8080/api/tasks" -Method Post -Body $task -ContentType "application/json"
$taskId = $result.data.taskId

# 2. 查询刚创建的任务
Invoke-RestMethod -Uri "http://localhost:8080/api/tasks/$taskId" -Method Get

# 3. 更新任务状态为扫描中
$update = @{ taskStatus = "SCANNING" } | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:8080/api/tasks/$taskId/status" -Method Put -Body $update -ContentType "application/json"

# 4. 再次查询任务，确认状态已更新
Invoke-RestMethod -Uri "http://localhost:8080/api/tasks/$taskId" -Method Get
```

### 场景2：查询个人任务列表

```powershell
# 查询zhangsan创建的所有任务
Invoke-RestMethod -Uri "http://localhost:8080/api/tasks?creator=zhangsan" -Method Get
```
